<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>리뷰 작성 - GreenHub</title>

    <!-- 시큐리티/CSRF 미사용: 관련 메타 제거 -->

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" th:href="@{/css/header.css}" />
    <link rel="stylesheet" th:href="@{/css/footer.css}" />
    <link rel="stylesheet" th:href="@{/css/review-write.css}" />

    <style>
        /* 폴백용 경량 스타일 (외부 CSS 없을 때 최소 동작) */
        .container{max-width:1040px;margin:0 auto;padding:24px}
        .product-info-section{display:flex;gap:20px;margin-bottom:24px;background:#fff;border-radius:16px;padding:20px;box-shadow:0 4px 20px rgba(0,0,0,.05)}
        .product-img{width:140px;height:140px;object-fit:cover;border-radius:12px;border:1px solid #eee}
        .product-info h1{margin:0 0 8px;font-size:22px}
        .product-price{margin-top:6px;color:#555}
        .review-write-section{background:#fff;border-radius:16px;padding:20px;box-shadow:0 4px 20px rgba(0,0,0,.05)}
        .review-textarea{width:100%;min-height:160px;padding:14px;border:2px solid #007bff;border-radius:10px;background:linear-gradient(135deg,#fff8f0 0%,#fef7ed 100%)}
        .textarea-footer{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
        .save-btn{padding:.6rem 1.2rem;border-radius:10px;border:0;background:#28a745;color:#fff;cursor:pointer;box-shadow:0 2px 8px rgba(40,167,69,.3)}
        .save-btn:disabled{opacity:.6;cursor:not-allowed}
        .star-rating{display:flex;gap:8px;align-items:center;margin:6px 0 4px}
        .star{font-size:28px;cursor:pointer;opacity:.35;user-select:none;transition:transform .15s ease}
        .star.active,.star:hover{opacity:1;transform:scale(1.05)}
        .form-error{color:#b30000;margin-top:8px;display:none}
        .error-box{background:#fff4f4;border:1px solid #ffd4d4;color:#b30000;padding:12px;border-radius:10px;margin:12px 0}
        .back-link{display:inline-block;margin:4px 0 16px;color:#1a73e8;text-decoration:none}
        body{font-family:'Noto Sans KR',sans-serif;background:#f8f9fa}
    </style>
</head>
<body>
<div th:replace="~{common/header :: header}"></div>

<main class="container"
      th:attr="data-order-item-id=${orderItemId}, data-product-id=${productId}">
    <a class="back-link" href="/review">← 리뷰 목록으로</a>

    <!-- 서버에서 온 에러 -->
    <div class="error-box" th:if="${errorMessage != null}" th:text="${errorMessage}">
        권한이 없거나 대상이 없습니다.
    </div>

    <section class="product-info-section" th:if="${errorMessage == null}">
        <div class="product-header">
            <div class="store-info">
                <span class="store-brand" th:text="${storeName != null ? storeName : '스토어'}">스토어</span>
            </div>
            <h1 class="product-title" th:text="${productName != null ? productName : '상품명'}">상품명</h1>
            <div class="product-details">
                <div class="price-info">
                    <span class="price-label">가격</span>
                    <span class="product-price"
                         th:text="${#strings.contains(priceText, '.')
                       ? #strings.substringBefore(priceText, '.') + '원'
                       : priceText}">-</span>
                </div>
                <div class="delivery-info" th:if="${deliveredAt != null}">
                    <span class="delivery-label">배송완료</span>
                    <span class="delivery-date" th:text="${#temporals.format(deliveredAt, 'yyyy-MM-dd HH:mm')}">배송완료일</span>
                </div>
            </div>
        </div>
    </section>

    <section class="review-write-section" th:if="${errorMessage == null}">
        <div class="satisfaction-section" aria-labelledby="ratingLabel">
            <h2 id="ratingLabel">상품 만족도</h2>
            <div class="star-rating" role="radiogroup" aria-label="별점 선택">
                <span class="star" data-rating="1" role="radio" aria-checked="false" aria-label="1점">★</span>
                <span class="star" data-rating="2" role="radio" aria-checked="false" aria-label="2점">★</span>
                <span class="star" data-rating="3" role="radio" aria-checked="false" aria-label="3점">★</span>
                <span class="star" data-rating="4" role="radio" aria-checked="false" aria-label="4점">★</span>
                <span class="star" data-rating="5" role="radio" aria-checked="false" aria-label="5점">★</span>
            </div>
            <input type="hidden" id="ratingValue" value="0" />
            <div class="form-error" id="ratingError">별점을 선택해 주세요.</div>
        </div>

        <div class="review-content-section">
            <h2>리뷰 작성</h2>
            <div class="review-textarea-container">
          <textarea id="reviewTextarea" class="review-textarea" maxlength="500"
                    placeholder="상품에 대한 솔직한 후기를 남겨주세요. 최소 10자"></textarea>
                <div class="textarea-footer">
                    <span class="char-count" id="charCount">0/500</span>
                    <button id="saveBtn" class="save-btn" type="button">저장하기</button>
                </div>
                <div class="form-error" id="contentError">리뷰는 최소 10자 이상 입력해 주세요.</div>
                <div class="form-error" id="saveError"></div>
                <div class="hint">※ 구매한 상품(배송완료)만 리뷰 작성이 가능합니다. 이미 작성한 상품은 중복 작성할 수 없습니다.</div>
            </div>
        </div>
    </section>
</main>

<div th:replace="~{common/footer :: footer}"></div>

<!-- 메인 스크립트 (있으면 이것만 실행) -->
<script th:src="@{/js/review-write.js}"></script>

<!-- 폴백: /js/review-write.js 가 없거나 로드 실패시 최소 동작 -->
<script>
    (function () {
      if (window.__REVIEW_WRITE_READY__) return;

      const stars = Array.from(document.querySelectorAll('.star-rating .star'));
      const ratingInput = document.getElementById('ratingValue');
      const ratingError = document.getElementById('ratingError');
      const ta = document.getElementById('reviewTextarea');
      const charCount = document.getElementById('charCount');
      const contentError = document.getElementById('contentError');
      const saveBtn = document.getElementById('saveBtn');

      // 별점
      stars.forEach(el => {
        el.addEventListener('click', () => {
          const val = Number(el.getAttribute('data-rating') || '0');
          ratingInput.value = String(val);
          stars.forEach(s => {
            const r = Number(s.getAttribute('data-rating') || '0');
            s.classList.toggle('active', r <= val);
            s.setAttribute('aria-checked', r === val ? 'true' : 'false');
          });
          ratingError.style.display = 'none';
        });
      });

      // 글자수
      const updateCount = () => {
        const len = (ta?.value || '').length;
        charCount.textContent = `${len}/500`;
        if (len >= 10) contentError.style.display = 'none';
      };
      ta?.addEventListener('input', updateCount);
      updateCount();

      // 저장(검증만)
      saveBtn?.addEventListener('click', () => {
        const rating = Number(ratingInput?.value || '0');
        const content = (ta?.value || '').trim();

        let ok = true;
        if (rating < 1) { ratingError.style.display = 'block'; ok = false; }
        if (content.length < 10) { contentError.style.display = 'block'; ok = false; }
        if (!ok) return;

        alert('검증 통과. 실제 저장은 /js/review-write.js 에 구현하세요.');
      });
    })();
</script>
</body>
</html>
